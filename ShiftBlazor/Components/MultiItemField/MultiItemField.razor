@using Microsoft.AspNetCore.Components.Forms
@using System.Collections

@typeparam T where T : IList
@typeparam TItem
@namespace ShiftSoftware.ShiftBlazor.Components

<MudCard Elevation="2" Class="@Classname" Style="@Style">
    <MudCardHeader Class="pt-1 pb-1 background-gray">
        <CardHeaderContent>
            <MudStack Row>
                @if (TitleTemplate == null)
                {
                    <MudStack Row>
                        <MudText Typo="Typo.subtitle2">@Title</MudText>
                        <ValidationMessage For="ValueExpression" />
                    </MudStack>
                }
                else
                {
                    @TitleTemplate
                }
                <MudSpacer/>

                @if (!DisableCounter)
                {
                    <MudText Color="Mode > FormModes.Archive && Value.Count < Min && UseLimits ? Color.Error : Color.Default">
                        @if (UseLimits)
                        {
                            <text>@Value.Count / @Math.Max(Min, 0)@(Max == 0 ? "+" : $"-{Max}")</text>
                        }
                        else
                        {
                            <text>@Value.Count</text>
                        }
                    </MudText>
                }
            </MudStack>
        </CardHeaderContent>
    </MudCardHeader>

    <MudCardContent Class="pt-2 pb-2">
        <MudGrid Spacing="3" Class="@GridClass" Style="@GridStyle">

            @if (FieldHeader != null)
            {
                <MudItem lg="11" md="11" sm="11" xs="11">
                    @FieldHeader(this)
                </MudItem>

                <MudItem lg="1" md="1" sm="1" xs="1"></MudItem>
            }

            @if (FieldBody != null)
            {
                @foreach (var item in Value)
                {
                    <MudItem @key="item" lg="12" md="12" sm="12" xs="12">
                        <SlideDown Hide="ItemsToRemove.Contains(item)" OnTransitionEnd="() => Remove(item)">
                            <MudGrid Class="@GridItemClass" Style="@GridItemStyle">
                                <MudItem lg="11" md="11" sm="11" xs="11">
                                    @FieldBody((TItem)item)
                                </MudItem>
                                <MudItem lg="1" md="1" sm="1" xs="1">
                                    @if (Mode > FormModes.Archive)
                                    {
                                        @if (RemoveButtonTempalte == null)
                                        {
                                            @GetRemoveButton((TItem)item)
                                        }
                                        else
                                        {
                                            @RemoveButtonTempalte(new(this, (TItem)item))
                                        }
                                    }
                                </MudItem>
                            </MudGrid>
                        </SlideDown>
                    </MudItem>
                }
            }

            @if (Mode > FormModes.Archive )
            {
                if (FieldFooter == null)
                {
                    <SlideDown Toggle="!UseLimits || Value.Count < Max || Max == 0" Style="margin:auto; margin-top:15px;">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Info"
                                   Size="Size.Small"
                                   OnClick="CreateNew"
                                   StartIcon="@Icons.Material.Filled.Add">
                            Add Line
                        </MudButton>
                    </SlideDown>
                }
                else
                {
                    @FieldFooter(this)
                }
            }
        </MudGrid>
    </MudCardContent>
</MudCard>

@code {
    private RenderFragment GetRemoveButton(object item)
    {
        return @<text>
            <MudIconButton ButtonType="ButtonType.Button"
                           Style="margin:10px;"
                           Variant="Variant.Text"
                           Color="Color.Default"
                           Size="Size.Small"
                           OnClick="() => AddRemoveTransition(item)"
                           Icon="@Icons.Material.Filled.Delete" />
        </text>;
    }
}
