@using Microsoft.AspNetCore.Components.Forms
@using System.Collections

@typeparam T
@namespace ShiftSoftware.ShiftBlazor.Components

<MudCard Elevation="2" Class="@Classname" Style="@Style">
    <MudCardHeader Class="pt-1 pb-1 background-gray">
        <CardHeaderContent>
            <MudStack Row>
                @if (TitleTemplate == null)
                {
                    <MudStack Row>
                        <MudText Typo="Typo.subtitle2">@Title</MudText>
                        <ValidationMessage For="ValueExpression" />
                    </MudStack>
                }
                else
                {
                    @TitleTemplate
                }
                <MudSpacer/>

                @if (!DisableCounter)
                {
                    <MudText Color="Mode > FormModes.Archive && Value.Count < Min && UseLimits ? Color.Error : Color.Default">
                        @if (UseLimits)
                        {
                            <text>@Value.Count / @Math.Max(Min, 0)@(Max == 0 ? "+" : $"-{Max}")</text>
                        }
                        else
                        {
                            <text>@Value.Count</text>
                        }
                    </MudText>
                }
            </MudStack>
        </CardHeaderContent>
    </MudCardHeader>

    <MudCardContent Class="pt-2 pb-2">
        <MudGrid Spacing="3" Class="@GridClassname" Style="@GridStyle">

            @if (FieldHeader != null)
            {
                <MudItem lg="11" md="11" sm="11" xs="11">
                    @FieldHeader(this)
                </MudItem>

                <MudItem lg="1" md="1" sm="1" xs="1"></MudItem>
            }

            @if (FieldBody != null)
            {
                <MudItem lg="12" md="12" sm="12" xs="12" >
                    <MudDropContainer @ref="DropContainer" T="T" Items="Value" ItemsSelector="(_, _) => true">
                        <ChildContent>
                            <MudDropZone AllowReorder="(!DisableDragAndDrop && Mode > FormModes.Archive)" T="T"></MudDropZone>
                        </ChildContent>

                        <ItemRenderer Context="item">
                            @{
                                var i = Value.IndexOf(item);
                            }
                            <div class="@ItemClassname(i)">
                                <SlideDown Hide="ItemsToRemove.Contains(item)" OnTransitionEnd="() => Remove(item)" >
                                    <MudGrid Class="@GridItemClass" Style="@GridItemStyle">
                                        <MudItem lg="11" md="11" sm="11" xs="11">
                                            @FieldBody(item)
                                        </MudItem>
                                        <MudItem lg="1" md="1" sm="1" xs="1">
                                            @if (Mode > FormModes.Archive)
                                            {
                                                @if (ControlTemplate == null)
                                                {
                                                    <MudButtonGroup Vertical="VerticalControls" Size="Size.Small" Variant="ControlVariant">

                                                        @if (!DisableReorder)
                                                        {
                                                            <MudIconButton ButtonType="ButtonType.Button"
                                                                            Color="Color.Default"
                                                                            OnClick="() => MoveUp(item)"
                                                                            Disabled="@(Value.IndexOf(item) <= 0)"
                                                                            Icon="@Icons.Material.Filled.ArrowUpward" />
                                                            <MudIconButton ButtonType="ButtonType.Button"
                                                                            Color="Color.Default"
                                                                            OnClick="() => MoveDown(item)"
                                                                            Disabled="@(Value.IndexOf(item) >= Value.Count - 1)"
                                                                            Icon="@Icons.Material.Filled.ArrowDownward" />
                                                        }

                                                        @if (!DisableRemove)
                                                        {
                                                            <MudIconButton ButtonType="ButtonType.Button"
                                                                           Color="Color.Error"
                                                                           OnClick="() => AddRemoveTransition(item)"
                                                                           Icon="@Icons.Material.Filled.Delete" />
                                                        }

                                                    </MudButtonGroup>
                                                }
                                                else
                                                {
                                                    @ControlTemplate(new(this, item))
                                                }
                                            }
                                        </MudItem>
                                    </MudGrid>
                                </SlideDown>
                            </div>
                        </ItemRenderer>
                    </MudDropContainer>
                </MudItem>
            }

            @if (Mode > FormModes.Archive )
            {
                if (FieldFooter == null)
                {
                    <SlideDown Toggle="!UseLimits || Value.Count < Max || Max == 0" Style="margin:auto; margin-top:15px;">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Info"
                                   Size="Size.Small"
                                   OnClick="CreateNew"
                                   StartIcon="@Icons.Material.Filled.Add">
                            Add Line
                        </MudButton>
                    </SlideDown>
                }
                else
                {
                    @FieldFooter(this)
                }
            }
        </MudGrid>
    </MudCardContent>
</MudCard>