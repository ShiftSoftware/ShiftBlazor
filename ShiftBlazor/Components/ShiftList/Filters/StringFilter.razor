@using ShiftSoftware.ShiftEntity.Model
@inherits FilterInput

<MudField Variant="Variant.Outlined" Label="@Name">

	@if (ShiftList == null)
	{
		<MudAlert>Filter Could not be loaded</MudAlert>
	}
	else
	{
		<MudStack Row AlignItems="AlignItems.End" Spacing="2">
			<MudSelectExtended T="ODataOperator" ValueChanged="OnOperatorChanged" Label="Operator">
				<MudSelectItem Value="ODataOperator.Equal">Equal</MudSelectItem>
				<MudSelectItem Value="ODataOperator.StartsWith">Starts With</MudSelectItem>
				<MudSelectItem Value="ODataOperator.EndsWith">Ends With</MudSelectItem>
				<MudSelectItem Value="ODataOperator.Contains">Contains</MudSelectItem>
				<MudSelectItem Value="ODataOperator.NotEqual">Not Equal</MudSelectItem>
				<MudSelectItem Value="ODataOperator.NotContains">Not Contains</MudSelectItem>
			</MudSelectExtended>

			@if (DtoType == null || Misc.GetAttribute<ShiftEntityKeyAndNameAttribute>(DtoType) == null || ShiftList.EntitySet == null)
			{
				<MudTextField T="string" Label="Value" ValueChanged="ValueChanged"></MudTextField>
			}
			else
			{
				var autocompleteType = typeof(ShiftAutocomplete<>).MakeGenericType(DtoType);
				var parameters = new Dictionary<string, object>() { ["EntitySet"] = ShiftList.EntitySet, ["DataTextField"] = Name };
				<DynamicComponent Type="autocompleteType" Parameters="parameters" />
			}

		</MudStack>
	}

</MudField>


@code
{
	[Parameter]
	public Type? DtoType { get; set; }

	private string? Value { get; set; }
	private ODataOperator SelectedOperator { get; set; }

	protected override void OnInitialized()
	{
		Console.WriteLine($"Initialized {Name}");
	}

	private void ValueChanged(string value)
	{
		Value = value;
		SetODataFilter();
	}

	private void SetODataFilter()
	{
		var filter = new ODataFilter
		{
			Field = Name,
			Operator = SelectedOperator,
			Value = Value ?? string.Empty
		};

		SetFilter(filter);
	}

	private void OnOperatorChanged(ODataOperator value)
	{
		SelectedOperator = value;
		SetODataFilter();
	}
}