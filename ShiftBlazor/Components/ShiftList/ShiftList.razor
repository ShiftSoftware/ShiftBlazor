@using ShiftSoftware.ShiftBlazor.Extensions
@using ShiftSoftware.ShiftBlazor.Enums
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Data
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Navigations
@typeparam T where T : ShiftEntityDTOBase, new()
@namespace ShiftSoftware.ShiftBlazor.Components
@inherits ShiftSoftware.ShiftBlazor.Events.EventComponentBase

@if (!string.IsNullOrWhiteSpace(Title))
{
    <PageTitle>@Title</PageTitle>
}

<MudPaper Elevation="25">

    <CascadingValue Value="this" IsFixed="true">

    <header>
        @if (!DisableHeaderToolbar)
        {
            <MudToolBar Dense="true" DisableGutters="false" Class="light-toolbar shift-toolbar-header">
                <MudIcon Icon="@IconSvg"></MudIcon>
                <MudText Class="px-4" Style="margin:0;">@(Title ?? Loc["ListDefaultTitle"])</MudText>

                @ToolbarStartTemplate

                <MudSpacer></MudSpacer>

                @ToolbarEndTemplate

                @if (IsEmbedded != true)
                {
                    @if (EnablePrint)
                    {
                        <MudTooltip Text="@Loc["PrintButton"]">
                            <MudIconButton Icon="@Icons.Material.Filled.Print"
                                           Color="Color.Warning"
                                           OnClick="PrintList" />
                        </MudTooltip>
                    }
                    @if (EnableCsvExcelExport || EnablePdfExport)
                    {
                        <MudTooltip Text="@Loc["DownloadButton"]">
                            <MudMenu Icon="@Icons.Material.Filled.FileDownload" Color="Color.Warning">
                                @if (EnableCsvExcelExport)
                                {
                                    <MudMenuItem OnClick="() => DownloadList(DownloadType.CSV)">@Loc["CSVExportButton"]</MudMenuItem>
                                    <MudMenuItem OnClick="() => DownloadList(DownloadType.Excel)">@Loc["ExcelExportButton"]</MudMenuItem>
                                }
                                @if (EnablePdfExport)
                                {
                                    <MudMenuItem OnClick="() => DownloadList(DownloadType.PDF)">@Loc["PDFExportButton"]</MudMenuItem>
                                }
                            </MudMenu>
                        </MudTooltip>
                    }
                }

                @if (RenderAddButton)
                {
                    <MudTooltip Text="@Loc["AddButton"]">
                        <MudButton Style="min-width:40px;"
                                   Variant="Variant.Text"
                                   Size="Size.Medium"
                                   Color="Color.Primary"
                                   OnClick="AddItem">
                            <MudIcon Size="Size.Medium" Icon="@Icons.Material.Filled.AddCircle" />
                        </MudButton>
                    </MudTooltip>
                }
                @if (MudDialog != null && IsEmbedded != true && (RenderAddButton || EnableCsvExcelExport || EnablePdfExport || EnablePrint))
                {
                    <MudDivider Vertical="true" Style="height: 60%;align-self: center;margin-inline: 5px;opacity: 0.5;"></MudDivider>
                }

                @if (MudDialog != null && IsEmbedded != true)
                {
                    @ToolbarControlsTemplate

                    <MudTooltip Text="@Loc["CloseButton"]">
                        <MudButton Style="min-width:40px; z-index: 100;"
                                   Variant="Variant.Text"
                                   Size="Size.Medium"
                                   Color="Color.Default"
                                   OnClick="CloseDialog">
                            <MudIcon Size="Size.Medium" Icon="@Icons.Material.Filled.Close" />
                        </MudButton>
                    </MudTooltip>
                }

            </MudToolBar>
        }

        @HeaderTemplate
    </header>

    @if (Values == null && string.IsNullOrWhiteSpace(Action))
    {
        <MudAlert Severity="Severity.Error">Both Action and Values parameters cannot be null</MudAlert>
    }
    else
    {
        <div class="@GridContainerCssClass">
            <SfGrid DataSource="Values"
                    TValue="T" @ref="Grid" class="pa-6"
                    ID="@GridId"
                    AllowPaging="!DisablePagination && !EnableVirtualization"
                    AllowSorting="!DisableSorting"
                    AllowMultiSorting="!DisableMultiSorting"
                    AllowExcelExport="EnableCsvExcelExport"
                    AllowPdfExport="EnablePdfExport"
                    AllowFiltering="!DisableFilters"
                    Query="Query"
                    AllowSelection="!DisableSelection"
                    EnableVirtualization="EnableVirtualization"
                    EnableVirtualMaskRow="EnableVirtualization"
                    Height="@GridHeight">

                @if (Values == null)
                {
                    <SfDataManager Url="@SettingManager.Configuration.ODataPath.AddUrlPath(Action)" Adaptor="Adaptors.ODataV4Adaptor" CrossDomain="true"/>
                }

                <GridEvents OnRecordClick="RecordClickHandler"
                            DataBound="DataBoundHandler"
                            OnActionFailure="ErrorHandler"
                            TValue="T" />
                <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
                <GridSelectionSettings CheckboxOnly="true" PersistSelection="true" Type="Syncfusion.Blazor.Grids.SelectionType.Multiple"></GridSelectionSettings>

                <GridPageSettings PageSize="@PageSize" PageSizes="@PageSizes">
                    <Template>
                        @{
                            var ctx = (PagerTemplateContext)context;
                            <Pagination Context="ctx" TValue="T"></Pagination>
                        }
                    </Template>
                </GridPageSettings>

                <GridColumns>
                    <GridColumn IsPrimaryKey="true" Visible="@(ShowIDColumn)" Field="@nameof(ShiftEntityDTOBase.ID)"></GridColumn>

                    @if (EnableVirtualization && !DisableSelection)
                    {
                        <GridColumn Type="ColumnType.CheckBox" Width="50">
                            <HeaderTemplate/>
                        </GridColumn>
                    }
                    else if (!DisableSelection)
                    {
                        <GridColumn Type="ColumnType.CheckBox" Width="50"></GridColumn>
                    }

                    @foreach (var column in GeneratedColumns)
                    {
                        if (column.IsComplex) {
                            <GridColumn HeaderText="@column.Label" Field="@column.Field" TextAlign="TextAlign.Left" FilterSettings="FilterSettingMenu"></GridColumn>
                        }
                        else {
                            <GridColumn HeaderText="@column.Label" Field="@column.Field" TextAlign="TextAlign.Left"></GridColumn>
                        }

                    }

                    @ColumnTemplate

                    @if (!ExcludedColumns.Contains("Actions", StringComparer.CurrentCultureIgnoreCase) && ComponentType != null)
                    {
                        <GridColumn HeaderText="@Loc["ActionsColumnTitle"]" TextAlign="TextAlign.Center" Width="@ActionColumnWidth">
                            <Template>
                                @if (ActionsTemplate == null)
                                {
                                    try
                                    {
                                        object? key = ((ShiftEntityDTOBase)context).ID;

                                        if (key == null)
                                        {
                                            throw new Exception();
                                        }
                                        <MudButton OnClick="@(() => OpenDialog(ComponentType, key, ModalOpenMode.Popup, this.AddDialogParameters))"
                                                   Variant="@Variant.Outlined"
                                                   EndIcon="@Icons.Material.Filled.OpenInNew"
                                                   Color="@Color.Primary"
                                                   Size="@Size.Small">
                                            @Loc["ViewButton"]
                                        </MudButton>
                                    }
                                    catch (Exception)
                                    {
                                        MsgService.Error(Loc["ActionButtonError"]);
                                    }
                                }
                                else
                                {
                                    @ActionsTemplate((T)context);
                                }
                            </Template>
                        </GridColumn>
                    }
                </GridColumns>

                @ChildContent
            </SfGrid>

            @if (ActionUrlBroken)
            {
                <div class="disabled-grid-overlay">
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Refresh" OnClick="ReloadGrid">@Loc["RefreshList"]</MudButton>
                </div>
            }
        </div>
    }

    </CascadingValue>
</MudPaper>

@code {
    public RenderFragment UnableToLoadDataTemplate = @<text></text>;
}