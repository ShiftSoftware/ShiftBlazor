@using ShiftSoftware.ShiftBlazor.Filters.Models
@using ShiftSoftware.ShiftEntity.Model
@inherits FilterUIBase


<MudSelectExtended T="ODataOperator" Value="Filter.Operator" ValueChanged="OperatorChanged" Label="Operator" >
	<MudSelectItem Value="ODataOperator.Equal">Equal</MudSelectItem>
	<MudSelectItem Value="ODataOperator.StartsWith">Starts With</MudSelectItem>
	<MudSelectItem Value="ODataOperator.EndsWith">Ends With</MudSelectItem>
	<MudSelectItem Value="ODataOperator.Contains">Contains</MudSelectItem>
	<MudSelectItem Value="ODataOperator.NotEqual">Not Equal</MudSelectItem>
	<MudSelectItem Value="ODataOperator.NotContains">Not Contains</MudSelectItem>
	<MudSelectItem Value="ODataOperator.IsNotEmpty">Is Set</MudSelectItem>
	<MudSelectItem Value="ODataOperator.IsEmpty">Is Not Set</MudSelectItem>
</MudSelectExtended>

@if (Filter.Operator != ODataOperator.IsEmpty && Filter.Operator != ODataOperator.IsNotEmpty)
{
	if (AutoCompleteType == null || AutoCompleteParameters == null)
	{
		<MudTextField T="string" Label="Value" Value="Value" ValueChanged="ValueChanged" />
	}
	else
	{
		<DynamicComponent Type="AutoCompleteType" Parameters="AutoCompleteParameters" />
	}
}

@code
{
	private string Value => (string?)Filter.Value ?? string.Empty;

	[CascadingParameter]
	public IShiftList? ShiftList { get; set; }

	private Type? AutoCompleteType;
	private Dictionary<string, object>? AutoCompleteParameters;

	protected override void OnInitialized()
	{
		base.OnInitialized();

		if (Filter is StringFilterModel stringFilter
			&& stringFilter.DtoType != null
			&& Misc.GetAttribute<ShiftEntityKeyAndNameAttribute>(stringFilter.DtoType) != null
			&& !string.IsNullOrWhiteSpace(ShiftList?.EntitySet))
		{
			AutoCompleteType = typeof(ShiftAutocomplete<>).MakeGenericType(stringFilter.DtoType);
			AutoCompleteParameters = new()
			{
				["EntitySet"] = ShiftList.EntitySet,
				["DataTextField"] = stringFilter.Field,
				["Strict"] = false,
				["ValueChanged"] = new EventCallback<ShiftEntitySelectDTO>(this, AutocompleteChanged)
			};
		}
	}

	protected override void OnParametersSet()
	{
		if (AutoCompleteParameters != null && ShiftList is IFilterableComponent filterable)
		{
			var filterList = filterable.Filters.Select(x => x.Value.ToODataFilter().ToString()).Where(x => !string.IsNullOrWhiteSpace(x));

			if (filterList.Any())
			{
				var filterQueryString = $"({string.Join(" and ", filterList)})";
				AutoCompleteParameters["Filter"] = delegate (ODataFilterGenerator x) { x.Add(filterQueryString); };
			}
		}

		base.OnParametersSet();
	}

	private void AutocompleteChanged(ShiftEntitySelectDTO? dto) {
		ValueChanged(dto?.Text);
	}

}